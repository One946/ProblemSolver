<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8" />
	<title>2.0</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">	
	<link rel="stylesheet" type="text/css" href="http://localhost/2.0/css/main.css">
</head>
<body class="parallax" id="body">
	

	<div class="container">
		<!-- navbar -->
			<nav class="navbar">
				<span class="open-slide">
					<a href="#" onclick="openSlideMenu()">
					  <svg width="30" height="30">
							<path d = "M0,5 30,5" stroke="#fff" stroke-width="5"/>
							<path d = "M0,14 30,14" stroke="#fff" stroke-width="5"/>
							<path d = "M0,23 30,23" stroke="#fff" stroke-width="5"/>
						</svg>
					</a>
				</span>
				<ul class="navbar-nav">
                    <li><a href="http://localhost/2.0/index.html"> Home</a><li>
                    <li><a href="http://localhost/2.0/problemi.html">Naviga Problemi</a></li>
                    <li><a href="http://localhost/2.0/risolti.html">Naviga Problemi Risolti</a></li>
					<li><a href="http://localhost/2.0/report.html">Riporta Problema</a></li>
					<li><a href="http://localhost/2.0/login.html">Login/Registrati</a></li>
                    <li><a href="http://localhost/2.0/cerca.html"> Cerca Problemi</a><li>
                    <button id="p"style="background-color:#3b5998; color:white; border:none;margin-top:15px;">LogOut</button>
                </ul>
                    <script>
                        //verifico se l'utente è loggato
                        var logged = document.cookie.substring(document.cookie.indexOf("secretID:"),document.cookie.indexOf(";"));
                        var a = logged.split("=");
                        var id = parseInt(a[1]);
                        if(!isNaN(id)){
                            document.getElementById("p").style.visibility="visibile";
                        }else{
                            document.getElementById("p").style.visibility="hidden";
                        }
    
    
                        document.getElementById("p").addEventListener("click",logout);
                        //funzione di logout
                    function logout(){
                        var d = new Date();
                          d.setTime(d.getTime() *0);
                          var expires = "expires="+ d.toUTCString();
                          console.log(document.cookie);
                          console.log(document.cookie["secretID"]);
                          //document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
                        document.cookie="secretID"+"="+document.cookie+";"+expires+"path=/"
                        console.log(document.cookie);
                    }
                    </script>

			</nav>
		<!--Menu a scomparsa-->
			<div id="side-menu" class="side-nav">
					<a href="#" class="btn-close" onclick="closeSlideMenu()">&times;</a>
					<a href="#">Home</a>
					<a href="#">Naviga Problemi</a></a>
					<a href="#">Riporta Problema</a>
					<a href="#">Login/Registrati</a>
            </div>
            
            <div id="problemi"></div>

    <div class="stripe" id="ricerca" style="opacity:0.94">

 
        <label for="cercaTag"> <b>Cerca problemi per tag </b> </label><br>
        <input type="text" id="cercaTag">
        <button id="1" onclick="cercaTag(spawnProb)">Cerca!</button><br>

        <label for="cercaCreatore"> <b>Cerca problemi per creatore </b></label><br>
        <input type="text" id="Nome"  placeholder="NOME"> <input type="text" id="Cognome"  placeholder="COGNOME">
        <button id="2" onclick="cercaCreatore(spawnProb)">Cerca!</button><br>

        <label for="cerca"> <b>Cerca utente più attivo </b> </label><br>    
         <button id="3" onclick="cercaAttivo()">Cerca!</button>  <br>  

        <label for="cerca"> <b>Cerca problemi per categoria categoria </b> </label><br>
        <select type="text" id="categoria" name="categoria" class="categoria" required>

        </select>
        <button id="4" onclick="cercaCategoria(spawnProb)">Cerca!</button>
    </div>


	<script>

			//script per aprire e chiudere il menù a scomparsa in modalità mobile
		function openSlideMenu(){
			document.getElementById("side-menu").style.width="250px"
			document.getElementById("main.").style.marginLeft="250px"
		}
		function closeSlideMenu(){
			document.getElementById("side-menu").style.width="0px"
			document.getElementById("main.").style.marginLeft="0px"
		}
        //popolo la select delle categorie dinamicamente
        var select = document.getElementById("categoria");

        var selectCategorie = function() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET","http://localhost/2.0/php/categorie.php");
        xhr.onload=function(){
            var arrCategorie = JSON.parse(xhr.responseText);
            var i=0; 
            while(i<arrCategorie.length){
                select.innerHTML+= `  <option value="${arrCategorie[i].descrizione}" > ${arrCategorie[i].descrizione} </option>  ` ; 
                i++;
            }
        };
        xhr.send();
        };

        select.addEventListener("click",selectCategorie, {once: true});
        //funzione di ricerca per tag
        function cercaTag(spawnProb){
            var stringTag = document.getElementById("cercaTag").value
            var xhr= new XMLHttpRequest;
            xhr.open("POST","http://localhost/2.0/php/cercaTag.php");
            xhr.onload=function(){
                var problemi =JSON.parse(this.responseText);
                for(i=0;i<problemi.length;i++){
                    spawnProb(problemi[i]);
                }
            };
            xhr.send(stringTag);
            
        }

        //funzione di ricerca per creatore
        function cercaCreatore(spawnProb){
            var utente={
                Nome: document.getElementById("Nome").value,
                Cognome: document.getElementById("Cognome").value
            };
            var xhr= new XMLHttpRequest;  
            xhr.open("POST","http://localhost/2.0/php/cercaCreatore.php");
            xhr.onload=function(){
                var problemi =JSON.parse(this.responseText);
                //console.log(JSON.parse(this.responseText));
                spawnProb(problemi);
            };
            xhr.send(JSON.stringify(utente));
                    // funzione di visualizzazione problemi
        }

        //funzione di ricerca per categoria
        function cercaCategoria(spawnProb){
            var categoria = document.getElementById("categoria").value
            var xhr= new XMLHttpRequest;
            console.log(categoria)
            xhr.open("POST","http://localhost/2.0/php/cercaCategoria.php");
            xhr.onload=function(){
                var problemi =JSON.parse(this.responseText);
                console.log(problemi);
                spawnProb(problemi);
            };
            xhr.send(categoria);  
        }

// funzione di ricerca dell'utente più attivo
            function cercaAttivo(){
                var xhr= new XMLHttpRequest;
                xhr.open("GET","http://localhost/2.0/php/cercaAttivo.php");
                xhr.onload=function(){
                    var utente = JSON.parse(this.responseText);
                    var xhr2 = new XMLHttpRequest;
                    xhr2.open("POST","http://localhost/2.0/php/probCount.php");
                    xhr2.onload=function(){
                        var count = (JSON.parse(this.responseText)["COUNT(*)"]); 
                        var divAttivo= document.createElement("div");
                        divAttivo.classList.add("stripe");
                        document.getElementById("body").appendChild(divAttivo);
                        document.getElementById("ricerca").remove();
                        var titoloAttivo = document.createElement("h1");
                        titoloAttivo.innerHTML="L'utente più attivo è :"+utente[0].Nome+" "+utente[0].Cognome;
                        var pAttivo= document.createElement("p");
                        pAttivo.innerHTML="Questo utente ha effettuato "+count+" post!";

                        divAttivo.appendChild(titoloAttivo);
                        divAttivo.appendChild(pAttivo);

                    };


                    xhr2.send(utente[0].secretID);
                };
                xhr.send();   
            }

//funzione per visualizzare i problemi
        function spawnProb(data){
            document.getElementById("ricerca").remove();    
		// visualizzo i problemi
			for(i=0; i< data.length; i++){
                var div;
                var h1;
                var p;
                var button;
                var testo;
                
                div=document.createElement("div");
                div.setAttribute("id", "probContainer");
                h1=document.createElement("h1");
                h1.setAttribute("id","titolo");
                p=document.createElement("p");
                p.setAttribute("id","descrizione");

                div.style.background="#f4f4f4";
                div.style.opacity="0.95";
                div.style.width="1000px"
                div.style.borderRadius="20px";
                div.style.color="#3b5998";
                div.style.margin="auto";
                div.style.textAlign="center";

                document.getElementById("problemi").appendChild(div);
                h1.innerHTML=data[i].titolo;
                p.innerHTML=data[i].descrizione;

                div.appendChild(h1);
                div.appendChild(p);
			}

		}
    </script>
</body>
</html>